
de_jure_shifting_effect = {
	while = {
		count = 25
		limit = {
			OR = {
				any_realm_de_jure_$LOWER_TIER$ = {
					mpo_de_jure_shifting_triggers = { UPPER_TIER = $UPPER_TIER$ }
				}
				any_tributary = {
					highest_held_title_tier < root.highest_held_title_tier
					any_realm_de_jure_$LOWER_TIER$ = {
						mpo_de_jure_shifting_triggers = { UPPER_TIER = $UPPER_TIER$ }
					}
				}
			}
		}
		random_realm_de_jure_$LOWER_TIER$ = {
			limit = {
				mpo_de_jure_shifting_triggers = { UPPER_TIER = $UPPER_TIER$ }
			}
			set_de_jure_liege_title = root.primary_title
			add_to_list = de_jure_shifted_title
		}
		random_tributary = {
			limit = {
				highest_held_title_tier < root.highest_held_title_tier
				any_realm_de_jure_$LOWER_TIER$ = {
					mpo_de_jure_shifting_triggers = { UPPER_TIER = $UPPER_TIER$ }
				}
			}
			random_realm_de_jure_$LOWER_TIER$ = {
				limit = {
					mpo_de_jure_shifting_triggers = { UPPER_TIER = $UPPER_TIER$ }
				}
				set_de_jure_liege_title = root.primary_title
				add_to_list = de_jure_shifted_title
			}
		}
	}
	###### OVERRIDE ######
	# while = {
	# 	count = 25
	# 	limit = {
	# 		list_size = {
	# 			name = de_jure_shifted_title
	# 			value >= 1
	# 		}
	# 	}
	# 	root = {
	# 		send_interface_message = {
	# 			type = msg_mpo_de_jure_shifting
	# 			title = msg_mpo_de_jure_shifting
	# 			left_icon = root
	# 			ordered_in_list = { 
	# 				order_by = {
	# 					value = 1
	# 				}
	# 				max = 3
	# 				list = de_jure_shifted_title
	# 				show_as_tooltip = {
	# 					set_de_jure_liege_title = root.primary_title 
	# 				}
	# 				remove_from_list = de_jure_shifted_title
	# 			}
	# 		}
	# 	}
	# }
	###### OVERRIDE ######
}


nomadic_realm_split_effect = {
	$ORIGINAL_REALM_HOLDER$ = {
		save_scope_as = root_scope
	}
	$NEW_RULER$ = {
		save_scope_as = new_ruler_scope
	}
	primary_title = {
		every_in_de_jure_hierarchy = {
			limit = {
				tier = tier_county
				holder.top_liege = scope:root_scope
			}
			add_to_list = de_jure_realm_counties_of_primary
			add_to_list = combined_counties_of_primary
		}
		every_in_de_jure_hierarchy = {
			limit = {
				tier = tier_county
				holder.top_liege != scope:root_scope
			}
			add_to_list = de_jure_realm_counties_of_primary_outside_realm
		}
		every_in_de_jure_hierarchy = {
			limit = {
				tier = tier_county
			}
			add_to_list = de_jure_realm_counties_of_primary_combined
		}
		every_in_de_facto_hierarchy = {
			limit = {
				tier = tier_county
				holder.top_liege ?= scope:root_scope
				NOT = { is_in_list = de_jure_realm_counties_of_primary }
			}
			add_to_list = de_facto_realm_counties_of_primary
			add_to_list = combined_counties_of_primary
		}
	}
	# Pick a suitable capital County, as far away from your capital as possible
	ordered_in_list = {
		list = de_jure_realm_counties_of_primary
		limit = {
			NOT = {
				this = scope:root_scope.capital_county
			}
		}
		order_by = {
			value = "title_province.squared_distance(scope:root_scope.capital_province)"
		}
		save_scope_as = new_capital
	}
	
	# Mark the capital duchy
	scope:new_ruler_scope = { 
		scope:new_capital = {
			add_to_list = counties_given_to_sibling
		}
		scope:new_capital.duchy = {
			save_scope_as = capital_duchy
			add_to_list = duchies_given_to_sibling
			add_to_list = duchies_to_de_jure_shift
			if = {
				limit = {
					holder.top_liege = scope:root_scope
					holder.primary_title.tier < tier_kingdom
				}
				holder = {
					add_to_list = rulers_transferred
				}
			}
			every_in_de_jure_hierarchy = {
				limit = {
					is_in_list = combined_counties_of_primary
				}
				add_to_list = capital_duchy_counties
				if = {
					limit = {
						NOT = {
							is_in_list = counties_given_to_sibling
						}
					}
					add_to_list = counties_given_to_sibling
				}
				if = {
					limit = {
						holder.top_liege = scope:root_scope
						holder.primary_title.tier < tier_kingdom
					}
					holder = {
						add_to_list = rulers_transferred
					}
				}
			}
		}
		# Expand in a 'ring' first
		scope:new_capital.duchy = {
			every_title_to_title_neighboring_duchy = {
				limit = {
					any_in_de_jure_hierarchy = {
						OR = {
							is_in_list = de_jure_realm_counties_of_primary
							is_in_list = de_jure_realm_counties_of_primary_outside_realm
						}
					}
				}
				add_to_list = duchies_to_de_jure_shift
				if = {
					limit = {
						any_in_de_jure_hierarchy = {
							is_in_list = de_jure_realm_counties_of_primary
						}
					}
					add_to_list = duchies_given_to_sibling
					if = {
						limit = {
							holder = {
								top_liege = scope:root_scope
								primary_title.tier < tier_kingdom
								NOT = { is_in_list = rulers_transferred }
							}
						}
						holder = {
							add_to_list = rulers_transferred
						}
					}
					every_in_de_jure_hierarchy = {
						limit = {
							is_in_list = de_jure_realm_counties_of_primary
						}
						add_to_list = counties_given_to_sibling
						if = {
							limit = {
								holder = {
									top_liege = scope:root_scope
									primary_title.tier < tier_kingdom
									NOT = { is_in_list = rulers_transferred }
								}
							}
							holder = {
								add_to_list = rulers_transferred
							}
						}
					}
					every_in_de_jure_hierarchy = {
						limit = {
							NOT = { is_in_list = de_jure_realm_counties_of_primary }
						}
						add_to_list = counties_de_jure_shifted_to_sibling
					}
				}
			}
		}
		while = {
			count = 50
			limit = {
				"list_size(counties_given_to_sibling)" < {
					value = "list_size(de_jure_realm_counties_of_primary)"
					multiply = $SPLIT_VALUE$
				}
			}
			ordered_in_list = {
				list = de_jure_realm_counties_of_primary_combined
				limit = {
					NOR = {
						duchy = scope:root_scope.capital_county.duchy
						duchy = { is_in_list = duchies_to_de_jure_shift }
						is_in_list = counties_given_to_sibling
					}
					any_neighboring_county = {
						OR = {
							is_in_list = counties_given_to_sibling
							duchy = { is_in_list = duchies_to_de_jure_shift }
						}
					}
				}
				order_by = {
					value = "title_province.squared_distance(scope:root_scope.capital_province)"
				}
				duchy = {
					add_to_list = duchies_to_de_jure_shift
					if = {
						limit = {
							any_in_de_jure_hierarchy = {
								is_in_list = de_jure_realm_counties_of_primary
							}
						}
						add_to_list = duchies_given_to_sibling
						if = {
							limit = {
								holder = {
									top_liege = scope:root_scope
									primary_title.tier < tier_kingdom
									NOT = { is_in_list = rulers_transferred }
								}
							}
							holder = {
								add_to_list = rulers_transferred
							}
						}
						every_in_de_jure_hierarchy = {
							limit = {
								is_in_list = de_jure_realm_counties_of_primary
							}
							add_to_list = counties_given_to_sibling
							if = {
								limit = {
									holder = {
										top_liege = scope:root_scope
										primary_title.tier < tier_kingdom
										NOT = { is_in_list = rulers_transferred }
									}
								}
								holder = {
									add_to_list = rulers_transferred
								}
							}
						}
						every_in_de_jure_hierarchy = {
							limit = {
								NOT = { is_in_list = de_jure_realm_counties_of_primary }
							}
							add_to_list = counties_de_jure_shifted_to_sibling
						}
					}
				}
			}
		}
		
		# Hand out the titles properly
		create_title_and_vassal_change = {
			type = swear_fealty
			add_claim_on_loss = yes
			save_scope_as = change
		}
		
		# Give capital + capital duchy
		scope:capital_duchy = {
			change_title_holder = {
				holder = scope:new_ruler_scope
				change = scope:change
			}
		}
		every_in_list = {
			list = capital_duchy_counties
			change_title_holder = {
				holder = scope:new_ruler_scope
				change = scope:change
			}
		}
		
		# Form a new kingdom
		save_scope_as = founder
		scope:capital_duchy = {
			save_scope_as = old_title
		}
		create_dynamic_title = {
			tier = kingdom
			name = NEW_CREATED_TITLE_NAME
		}
		scope:new_title = {
			save_scope_as = new_kingdom_title
			change_title_holder = {
				holder = scope:new_ruler_scope
				change = scope:change
			}
			generate_coa = yes
			set_de_jure_liege_title = scope:root_scope.primary_title.empire
		}
		
		# Do everything else
		every_in_list = {
			list = counties_given_to_sibling
			if = {
				limit = {
					holder = {
						NOT = {
							this = scope:new_ruler_scope
						}
						OR = {
							this = scope:root_scope
							primary_title.tier >= tier_kingdom
						}
					}
				}
				change_title_holder = {
					holder = scope:new_ruler_scope
					change = scope:change
				}
			}
			if = {
				limit = {
					NOT = {
						this = scope:new_ruler_scope
					}
					holder = {
						liege = scope:root_scope
						primary_title.tier < tier_kingdom
					}
				}
				holder = {
					change_liege = {
						liege = scope:new_ruler_scope
						change = scope:change
					}
				}
			}
		}
		
		resolve_title_and_vassal_change = scope:change
			
		###### OVERRIDE ######
		# every_in_list = {
		# 	list = duchies_to_de_jure_shift
		# 	set_de_jure_liege_title = scope:new_kingdom_title
		# }
		###### OVERRIDE ######
	}
}
